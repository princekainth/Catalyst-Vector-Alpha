<!DOCTYPE html>
<html lang="en" class="dark">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Catalyst Vector Alpha | CVA</title>

  <!-- Tailwind CSS -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- Google Fonts & Font Awesome -->
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=Fira+Code&display=swap" rel="stylesheet" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" />

  <!-- Toastify.js for Notifications -->
  <link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/toastify-js/src/toastify.min.css" />
  <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/toastify-js"></script>

  <!-- Chart.js for Resource Usage Visualization -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <style>
    body { font-family: 'Inter', sans-serif; background-color: #030712; color: #d1d5db; }
    .font-mono { font-family: 'Fira Code', monospace; }
    ::-webkit-scrollbar { width: 8px; }
    ::-webkit-scrollbar-track { background: #111827; }
    ::-webkit-scrollbar-thumb { background: #374151; border-radius: 4px; }
    .modal { background-color: rgba(17, 24, 39, 0.8); backdrop-filter: blur(12px); }
    .modal-content { animation: fadeIn 0.3s ease-out; }
    @keyframes fadeIn { from { opacity: 0; transform: translateY(-20px) scale(0.98); } to { opacity: 1; transform: translateY(0) scale(1); } }
    .agent-sidebar-link.active { background-color: #1d4ed8; color: white; }
    .status-dot { animation: pulse 2s infinite; }
    @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.5; } }
    .stat-bar-bg { background-color: #374151; }
    .stat-bar-fill { transition: width 0.5s ease-in-out; }
    .memory-item { cursor: pointer; }
    .memory-item:hover { background-color: rgba(255, 255, 255, 0.05); }
    .json-key { color: #60a5fa; }
    .json-string { color: #34d399; }
    .json-number { color: #f59e0b; }
    .json-boolean { color: #f472b6; }
    .json-null { color: #6b7280; }
    .loading-btn { opacity: 0.7; cursor: not-allowed; }
  </style>
</head>
<body class="flex h-screen overflow-hidden text-sm">
  <!-- Left Sidebar -->
  <aside class="w-64 bg-[#0a0f1b] p-4 flex flex-col h-full border-r border-gray-800 shrink-0">
    <div class="flex items-center mb-6 shrink-0">
      <i class="fas fa-atom text-blue-500 text-2xl mr-3"></i>
      <h1 class="text-xl font-bold text-white">Catalyst Vector</h1>
    </div>
    <a href="#" id="show-all-agents" class="flex items-center p-2 text-sm text-gray-200 bg-gray-700/50 hover:bg-gray-700 rounded-lg transition-colors mb-4" aria-label="Show all agents">
      <i class="fas fa-border-all w-8 text-center text-gray-400"></i>
      <span>Show All Agents</span>
    </a>
    <h2 class="text-xs font-semibold text-gray-500 uppercase tracking-wider mb-2">Agents</h2>
    <div id="agents-sidebar" class="flex-grow overflow-y-auto pr-2 space-y-1"></div>
  </aside>

  <!-- Center Column -->
  <main class="flex-1 flex flex-col bg-gray-900 h-full border-r border-gray-800">
    <header class="bg-gray-900/70 backdrop-blur-sm border-b border-gray-800 p-4 flex justify-between items-center shrink-0">
      <h2 id="agent-detail-title" class="text-xl font-semibold text-white">Select an Agent</h2>
    </header>
    <div id="agent-detail-container" class="flex-grow p-6 overflow-y-auto"></div>
  </main>

  <!-- Right Sidebar -->
  <aside class="w-96 bg-[#0a0f1b] p-4 flex flex-col h-full shrink-0">
    <h2 class="text-sm font-semibold text-gray-400 uppercase tracking-wider mb-4">System Overview</h2>
    <div id="status-container" class="bg-gray-800/50 rounded-lg p-4 mb-6">
      <canvas id="resource-chart" class="mt-4"></canvas>
    </div>

    <div id="system-control-container" class="mb-6"></div>

    <h2 class="text-sm font-semibold text-gray-400 uppercase tracking-wider mb-4">Human Intervention</h2>
    <div id="intervention-container" class="mb-6"></div>

    <h2 class="text-sm font-semibold text-gray-400 uppercase tracking-wider mb-4">Live System Log</h2>
    <div id="live-log-container" class="flex-grow overflow-y-auto bg-gray-900/50 rounded-lg p-3 font-mono text-xs space-y-2"></div>
  </aside>

  <!-- Response Modal -->
  <div id="response-modal" class="modal fixed inset-0 z-50 flex items-center justify-center" style="display:none;" role="dialog" aria-labelledby="response-modal-title">
    <div class="modal-content bg-gray-800 border border-gray-700 rounded-xl p-6 max-w-2xl w-full shadow-xl">
      <div class="flex justify-between items-center mb-4">
        <h3 id="response-modal-title" class="text-lg font-semibold text-white">Agent Response</h3>
        <button id="close-response-modal" class="text-gray-400 hover:text-white" aria-label="Close response modal"><i class="fas fa-times"></i></button>
      </div>
      <div id="response-modal-body" class="text-gray-200 text-sm"></div>
    </div>
  </div>

  <!-- Memory Modal -->
  <div id="memory-modal" class="modal fixed inset-0 z-50 flex items-center justify-center" style="display:none;" role="dialog" aria-labelledby="memory-modal-title">
    <div class="modal-content bg-gray-800 border border-gray-700 rounded-xl p-6 max-w-2xl w-full shadow-xl">
      <div class="flex justify-between items-center mb-4">
        <h3 id="memory-modal-title" class="text-lg font-semibold text-white">Memory</h3>
        <button id="close-memory-modal" class="text-gray-400 hover:text-white" aria-label="Close memory modal"><i class="fas fa-times"></i></button>
      </div>
      <div id="memory-modal-body" class="text-gray-200 text-sm space-y-2 font-mono"></div>
    </div>
  </div>

  <script>
    // ---------- Helpers ----------
    const API_KEY = 'your-secure-key-here'; // Set to match CATALYST_API_KEY in app.py
    const safeToast = (opts) => { try { Toastify(opts).showToast(); } catch (_) {} };

    function formatDuration(totalSeconds) {
      const s = Math.max(0, parseInt(totalSeconds || 0, 10));
      const h = Math.floor(s / 3600);
      const m = Math.floor((s % 3600) / 60);
      const sec = s % 60;
      if (h) return `${h}h ${m}m ${sec}s`;
      if (m) return `${m}m ${sec}s`;
      return `${sec}s`;
    }

    function percentFromMetric(val) {
      if (val == null) return null;
      if (typeof val === 'number') {
        if (val <= 1) return Math.max(0, Math.min(100, Math.round(val * 100)));
        return Math.max(0, Math.min(100, Math.round(val)));
      }
      if (typeof val === 'object') {
        const v = val.value ?? val.current ?? null;
        const m = val.max ?? val.target ?? null;
        if (typeof v === 'number' && typeof m === 'number' && m > 0) {
          return Math.max(0, Math.min(100, Math.round((v / m) * 100)));
        }
        if (typeof val.percent === 'number') {
          return Math.max(0, Math.min(100, Math.round(val.percent)));
        }
      }
      return null;
    }

    function debounce(func, wait) {
      let timeout;
      return function (...args) {
        clearTimeout(timeout);
        timeout = setTimeout(() => func.apply(this, args), wait);
      };
    }

    function setButtonLoading(btnId, isLoading) {
      const btn = document.getElementById(btnId);
      if (!btn) return;
      if (isLoading) {
        btn.classList.add('loading-btn');
        btn.disabled = true;
        const icon = btn.querySelector('i');
        if (icon) {
          icon.className = 'fas fa-spinner fa-spin mr-2';
        }
      } else {
        btn.classList.remove('loading-btn');
        btn.disabled = false;
        const icon = btn.querySelector('i');
        if (icon) {
          if (btnId === 'resume-btn') icon.className = 'fas fa-play mr-2';
          if (btnId === 'pause-btn') icon.className = 'fas fa-pause mr-2';
          if (btnId === 'send-intent-btn') icon.className = 'fas fa-paper-plane';
          if (btnId === 'submit-response-btn') icon.className = '';
        }
      }
    }

    function renderPerfBars(perf) {
      if (!perf || typeof perf !== 'object' || !Object.keys(perf).length) {
        return '<div class="text-gray-400 text-sm">No performance metrics.</div>';
      }
      const rows = Object.entries(perf).map(([k, v]) => {
        const pct = percentFromMetric(v);
        let rightLabel = '';
        if (typeof v === 'object') {
          const cur = v.value ?? v.current;
          const max = v.max ?? v.target;
          if (typeof cur === 'number' && typeof max === 'number') rightLabel = `${cur} / ${max}`;
          else if (typeof v.percent === 'number') rightLabel = `${Math.round(v.percent)}%`;
        } else if (typeof v === 'number' && pct !== null) {
          rightLabel = `${pct}%`;
        }
        return `
          <div>
            <div class="flex justify-between text-xs mb-1">
              <span class="text-gray-300">${k.replace(/_/g,' ')}</span>
              <span class="text-gray-400">${rightLabel}</span>
            </div>
            <div class="w-full h-2 rounded stat-bar-bg">
              <div class="h-2 rounded bg-indigo-500 stat-bar-fill" style="width:${pct ?? 0}%"></div>
            </div>
          </div>
        `;
      }).join('');
      return `<div class="space-y-3">${rows}</div>`;
    }

    function renderKeyValues(obj) {
      if (!obj || typeof obj !== 'object' || !Object.keys(obj).length) {
        return '<div class="text-gray-400 text-sm">No metrics.</div>';
      }
      const formatValue = (val, depth = 0) => {
        if (val === null) return '<span class="json-null">null</span>';
        if (typeof val === 'string') return `<span class="json-string">"${val}"</span>`;
        if (typeof val === 'number') return `<span class="json-number">${val}</span>`;
        if (typeof val === 'boolean') return `<span class="json-boolean">${val}</span>`;
        if (Array.isArray(val)) {
          return `[${val.map(v => formatValue(v, depth + 1)).join(', ')}]`;
        }
        if (typeof val === 'object') {
          const indent = '  '.repeat(depth + 1);
          const entries = Object.entries(val).map(([k, v]) => {
            return `<div style="margin-left: ${depth * 1.5}em;"><span class="json-key">"${k}"</span>: ${formatValue(v, depth + 1)}</div>`;
          }).join('');
          return `<div>{${entries}}</div>`;
        }
        return String(val);
      };
      return `
        <div class="text-xs text-gray-300 space-y-1">
          ${Object.entries(obj).map(([k, v]) => `
            <div class="flex justify-between">
              <span class="json-key">${k}</span>
              <span class="text-gray-200">${formatValue(v)}</span>
            </div>`).join('')}
        </div>`;
    }

    function renderMemories(items) {
      if (!Array.isArray(items) || !items.length) {
        return '<div class="text-gray-400 text-sm">No recent memories.</div>';
      }
      return `
        <div class="space-y-3">
          ${items.map((it, idx) => {
            const title = it.title || it.type || it.event || 'Memory';
            const outcome = it.outcome || it.status || '';
            const summary = it.summary || it.description || it.text || '';
            const ts = it.timestamp || it.time || '';
            return `
              <div class="bg-gray-900/50 border border-gray-700 rounded p-3 memory-item" data-idx="${idx}">
                <div class="flex items-center justify-between mb-1">
                  <div class="text-gray-200 text-sm font-medium">${title}</div>
                  <div class="text-xs text-gray-500">${ts}</div>
                </div>
                ${outcome ? `<div class="text-xs text-green-400 mb-1">${outcome}</div>` : ''}
                <div class="text-xs text-gray-300 whitespace-pre-wrap">${summary}</div>
              </div>`;
          }).join('')}
        </div>`;
    }

    // ---------- App ----------
    const DashboardApp = {
      state: {
        currentAgent: null,
        agents: [],
        statusTimer: null,
        interventionTimer: null,
      },

      elements: {
        systemControlContainer: document.getElementById('system-control-container'),
        agentsSidebar: document.getElementById('agents-sidebar'),
        agentDetailContainer: document.getElementById('agent-detail-container'),
        agentDetailTitle: document.getElementById('agent-detail-title'),
        statusContainer: document.getElementById('status-container'),
        liveLogContainer: document.getElementById('live-log-container'),
        interventionContainer: document.getElementById('intervention-container'),
        showAllAgentsBtn: document.getElementById('show-all-agents'),
        responseModal: document.getElementById('response-modal'),
        responseModalBody: document.getElementById('response-modal-body'),
        closeResponseModal: document.getElementById('close-response-modal'),
        memoryModal: document.getElementById('memory-modal'),
        memoryModalBody: document.getElementById('memory-modal-body'),
        closeMemoryModal: document.getElementById('close-memory-modal'),
      },

      init() {
        this.bindEvents();
        this.bootstrap();
      },

      bindEvents() {
        this.elements.showAllAgentsBtn?.addEventListener('click', (e) => {
          e.preventDefault();
          this.renderAgentsList(this.state.agents);
          this.state.currentAgent = null;
          this.elements.agentDetailTitle.textContent = 'Select an Agent';
          this.elements.agentDetailContainer.innerHTML = '';
        });
        this.elements.closeResponseModal?.addEventListener('click', () => this.hideResponseModal());
        this.elements.closeMemoryModal?.addEventListener('click', () => this.hideMemoryModal());
      },

      async bootstrap() {
        await Promise.all([
          this.fetchStatus(),
          this.fetchAgents.bind(this)(),
          this.fetchInterventions()
        ]);
        this.initLiveLogs();
        clearInterval(this.state.statusTimer);
        this.state.statusTimer = setInterval(() => this.fetchStatus(), 10000);
        clearInterval(this.state.interventionTimer);
        this.state.interventionTimer = setInterval(() => this.fetchInterventions(), 10000);
      },

      // ---- API Calls ----
      async fetchWithAuth(url, options = {}) {
        return fetch(url, {
          ...options,
          headers: { ...options.headers, 'X-API-Key': API_KEY }
        });
      },

      async fetchStatus() {
        try {
          const res = await this.fetchWithAuth('/api/status');
          if (!res.ok) throw new Error('HTTP ' + res.status);
          const data = await res.json();
          this.renderStatus(data);
        } catch (err) {
          this.renderStatus({ system_paused: true, uptime: 0, agents_online: 0 });
          console.warn('Status error:', err);
        }
      },

      fetchAgents: async function() {
        try {
          const res = await this.fetchWithAuth('/api/agents');
          if (!res.ok) {
            const errorData = await res.json().catch(() => ({ message: `HTTP ${res.status}` }));
            throw new Error(errorData.message || `HTTP ${res.status}`);
          }
          const data = await res.json();
          this.state.agents = Array.isArray(data) ? data : (data.agents || []);
          if (!this.state.agents.length) {
            this.elements.agentsSidebar.innerHTML = '<div class="text-xs text-yellow-400">No agents available.</div>';
          } else {
            this.renderAgentsList(this.state.agents);
            if (typeof this.selectAgent === 'function' && this.state.agents.length) {
              this.selectAgent(this.state.agents[0].name || this.state.agents[0]);
            } else {
              console.warn('selectAgent is not a function or no agents to select');
              this.elements.agentDetailTitle.textContent = 'No Agents Available';
              this.elements.agentDetailContainer.innerHTML = '<div class="text-xs text-yellow-400">No agents to display.</div>';
            }
          }
        } catch (err) {
          this.elements.agentsSidebar.innerHTML = `<div class="text-xs text-red-400">Failed to load agents: ${err.message}</div>`;
          console.warn('Agents error:', err);
        }
      },

      async fetchAgentDetail(agentName) {
        const res = await this.fetchWithAuth(`/api/agent/${encodeURIComponent(agentName)}`);
        if (!res.ok) throw new Error('HTTP ' + res.status);
        return res.json();
      },

      async fetchInterventions() {
        try {
          const res = await this.fetchWithAuth('/api/pending_interventions');
          if (!res.ok) throw new Error('HTTP ' + res.status);
          const data = await res.json();
          this.renderInterventions(Array.isArray(data) ? data : []);
        } catch (err) {
          console.warn('Interventions error:', err);
          this.renderInterventions([]);
        }
      },

      initLiveLogs() {
        const source = new EventSource('/api/live_logs');
        source.onmessage = (event) => {
          try {
            const log = JSON.parse(event.data);
            this.renderLogs([log], true);
          } catch (err) {
            console.warn('Log parse error:', err);
          }
        };
        source.onerror = () => console.warn('SSE error');
      },

      // ---- Actions ----
      async controlSystem(action) {
        const btnId = action === 'pause' ? 'pause-btn' : 'resume-btn';
        setButtonLoading(btnId, true);
        try {
          const res = await this.fetchWithAuth(`/api/system/${action}`, { method: 'POST' });
          const data = await res.json().catch(() => ({ message: 'Action sent.' }));
          safeToast({ text: data.message || 'Action sent', className: 'info', style: { background: '#2563eb' } });
          this.fetchStatus();
        } catch (err) {
          safeToast({ text: 'Failed to control system', className: 'error', style: { background: '#ef4444' } });
        } finally {
          setButtonLoading(btnId, false);
        }
      },

      async overrideIntent() {
        const input = document.getElementById('intent-override-input');
        const newIntent = input?.value || '';
        if (!newIntent.trim() || !this.state.currentAgent) return;
        setButtonLoading('send-intent-btn', true);
        try {
          const res = await this.fetchWithAuth(`/api/agent/${encodeURIComponent(this.state.currentAgent)}/intent`, {
            method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ intent: newIntent })
          });
          const data = await res.json().catch(() => ({ message: 'Intent override sent.' }));
          safeToast({ text: data.message || 'Intent override sent', className: 'info', style: { background: '#10b981' } });
          setTimeout(() => this.selectAgent(this.state.currentAgent), 600);
        } catch (err) {
          safeToast({ text: 'Failed to override intent', className: 'error', style: { background: '#ef4444' } });
        } finally {
          setButtonLoading('send-intent-btn', false);
        }
      },

      async selectAgent(agentName) {
        this.state.currentAgent = agentName;
        this.highlightActiveAgent(agentName);
        this.elements.agentDetailTitle.textContent = agentName;
        try {
          const agent = await this.fetchAgentDetail(agentName);
          this.renderAgentDetail(agent);
        } catch (err) {
          const fallback = (this.state.agents || []).find(a => (a.name || a) === agentName) || { name: agentName };
          this.renderAgentDetail(fallback);
        }
      },

      async submitInterventionResponse(requestId, response) {
        setButtonLoading('submit-response-btn', true);
        try {
          const res = await this.fetchWithAuth('/api/inject_directive', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ type: 'HUMAN_RESPONSE', payload: { request_id: requestId, response } })
          });
          const data = await res.json();
          safeToast({ text: data.message || 'Response sent', style: { background: '#10b981' } });
          this.hideResponseModal();
          this.fetchInterventions();
        } catch (err) {
          safeToast({ text: 'Failed to submit response', style: { background: '#ef4444' } });
        } finally {
          setButtonLoading('submit-response-btn', false);
        }
      },

      // ---- Renderers ----
      renderStatus(status) {
        const isPaused = !!status.system_paused;
        const uptime = status.uptime || 0;
        const agentsOnline = status.agents_online || (this.state.agents?.length || 0);
        const cpu = status.resource_usage?.cpu_percent;
        const mem = status.resource_usage?.memory_percent;

        this.elements.statusContainer.innerHTML = `
          <div class="flex items-center justify-between">
            <div class="flex items-center space-x-2">
              <span class="w-2.5 h-2.5 rounded-full ${isPaused ? 'bg-yellow-400' : 'bg-green-400'} status-dot"></span>
              <span class="text-sm ${isPaused ? 'text-yellow-300' : 'text-green-300'}">${isPaused ? 'Paused' : 'Running'}</span>
            </div>
            <div class="text-xs text-gray-400">Uptime: ${formatDuration(uptime)}</div>
          </div>
          <div class="mt-3 text-xs text-gray-300">Agents online: ${agentsOnline}</div>
          ${ (cpu != null && mem != null) ? `<div class="mt-2 text-xs text-gray-400">CPU / Memory: ${cpu}% / ${mem}%</div>` : '' }
          <canvas id="resource-chart" class="mt-4"></canvas>
        `;
        this.renderSystemControls(isPaused);
        this.renderResourceChart(status.resource_usage || {});
      },

      renderResourceChart(usage) {
        const ctx = document.getElementById('resource-chart')?.getContext('2d');
        if (!ctx) return;
        new Chart(ctx, {
          type: 'bar',
          data: {
            labels: ['CPU', 'Memory'],
            datasets: [{
              label: 'Resource Usage (%)',
              data: [usage.cpu_percent || 0, usage.memory_percent || 0],
              backgroundColor: ['#4f46e5', '#10b981'],
              borderColor: ['#4f46e5', '#10b981'],
              borderWidth: 1
            }]
          },
          options: {
            responsive: true,
            scales: { y: { beginAtZero: true, max: 100 } },
            plugins: { legend: { display: false } }
          }
        });
      },

      renderSystemControls(isPaused) {
        let controlHtml = '';
        if (isPaused) {
          controlHtml = `<button id="resume-btn" class="w-full text-center bg-green-600 hover:bg-green-500 text-white font-bold py-2 px-3 rounded text-sm transition-colors" aria-label="Resume system"><i class="fas fa-play mr-2"></i>Resume System</button>`;
        } else {
          controlHtml = `<button id="pause-btn" class="w-full text-center bg-yellow-600 hover:bg-yellow-500 text-white font-bold py-2 px-3 rounded text-sm transition-colors" aria-label="Pause system"><i class="fas fa-pause mr-2"></i>Pause System</button>`;
        }
        this.elements.systemControlContainer.innerHTML = controlHtml;
        document.getElementById('resume-btn')?.addEventListener('click', () => this.controlSystem('unpause'));
        document.getElementById('pause-btn')?.addEventListener('click', () => this.controlSystem('pause'));
      },

      renderAgentsList(agents) {
        const list = (agents || []).map(a => {
          const name = a.name || a;
          const status = a.status || 'unknown';
          const role = a.role || '';
          return `
            <button data-agent="${name}" class="agent-sidebar-link w-full text-left flex items-center p-2 text-sm rounded-lg transition-colors hover:bg-gray-700/60" aria-label="Select agent ${name}">
              <span class="w-2.5 h-2.5 rounded-full mr-2 ${status === 'running' ? 'bg-green-400' : status === 'paused' ? 'bg-yellow-400' : 'bg-gray-500'}"></span>
              <div class="flex-1">
                <div class="text-gray-200 truncate">${name}</div>
                ${role ? `<div class="text-[10px] text-gray-400 truncate">${role}</div>` : ''}
              </div>
            </button>`;
        }).join('');
        this.elements.agentsSidebar.innerHTML = list || '<div class="text-xs text-gray-400">No agents found.</div>';
        this.elements.agentsSidebar.querySelectorAll('.agent-sidebar-link').forEach(btn => {
          btn.addEventListener('click', () => this.selectAgent(btn.getAttribute('data-agent')));
        });
      },

      highlightActiveAgent(agentName) {
        this.elements.agentsSidebar.querySelectorAll('.agent-sidebar-link').forEach(btn => {
          const active = btn.getAttribute('data-agent') === agentName;
          btn.classList.toggle('active', active);
        });
      },

      renderAgentDetail(agent) {
        const name = agent.name || this.state.currentAgent || 'Agent';
        const role = agent.role || agent.type || '—';
        const status = agent.status || 'unknown';
        const intent = (agent.intent && (agent.intent.current || agent.intent)) || '—';
        const metrics = agent.metrics || {};
        const capabilities = agent.capabilities || [];
        const perf = agent.performance_metrics || agent.performance || agent.perf_metrics || {};
        const memories = agent.recent_memories || agent.memories || agent.memory_log || [];

        const overrideFormHtml = `
          <div class="bg-gray-800/60 border border-gray-700 rounded-lg p-4">
            <h3 class="text-sm font-semibold text-gray-300 uppercase tracking-wider mb-2">Override Intent</h3>
            <div class="flex space-x-2">
              <input type="text" id="intent-override-input" class="flex-grow bg-gray-900 border border-gray-700 rounded-md p-2 text-gray-200 focus:ring-2 focus:ring-blue-500 focus:outline-none" placeholder="Enter new intent..." aria-label="New intent" />
              <button id="send-intent-btn" class="px-4 py-2 bg-indigo-600 hover:bg-indigo-500 text-white rounded-md font-semibold transition-colors shrink-0" aria-label="Send intent override">
                <i class="fas fa-paper-plane"></i>
              </button>
            </div>
          </div>`;

        this.elements.agentDetailContainer.innerHTML = `
          <div class="space-y-6">
            <div class="flex items-center justify-between">
              <div>
                <div class="text-xs text-gray-400">${role}</div>
                <div class="text-2xl font-semibold text-white">${name}</div>
              </div>
              <div class="text-sm">
                <span class="px-2 py-1 rounded-full ${status === 'running' ? 'bg-green-600/30 text-green-300' : status === 'paused' ? 'bg-yellow-600/30 text-yellow-300' : 'bg-gray-600/30 text-gray-300'}">${status}</span>
              </div>
            </div>

            ${overrideFormHtml}

            <div class="bg-gray-800/60 border border-gray-700 rounded-lg p-4">
              <h4 class="text-sm font-semibold text-gray-300 mb-2">Current Intent</h4>
              <div class="text-gray-200 text-sm whitespace-pre-wrap">${intent}</div>
            </div>

            <div class="grid grid-cols-1 lg:grid-cols-2 gap-4">
              <div class="bg-gray-800/60 border border-gray-700 rounded-lg p-4">
                <h4 class="text-sm font-semibold text-gray-300 mb-2">Performance Metrics</h4>
                ${renderPerfBars(perf)}
              </div>
              <div class="bg-gray-800/60 border border-gray-700 rounded-lg p-4">
                <h4 class="text-sm font-semibold text-gray-300 mb-2">Metrics</h4>
                ${renderKeyValues(metrics)}
              </div>
            </div>

            <div class="bg-gray-800/60 border border-gray-700 rounded-lg p-4">
              <h4 class="text-sm font-semibold text-gray-300 mb-2">Capabilities</h4>
              ${capabilities.length
                ? `<ul class="list-disc pl-5 text-sm text-gray-200">${capabilities.map(c => `<li>${c}</li>`).join('')}</ul>`
                : '<div class="text-gray-400 text-sm">—</div>'
              }
            </div>

            <div class="bg-gray-800/60 border border-gray-700 rounded-lg p-4">
              <h4 class="text-sm font-semibold text-gray-300 mb-2">Recent Memories</h4>
              ${renderMemories(memories)}
            </div>
          </div>
        `;

        const intentInput = document.getElementById('intent-override-input');
        const intentBtn = document.getElementById('send-intent-btn');
        if (intentInput && intentBtn) {
          intentBtn.disabled = !intentInput.value.trim();
          intentInput.addEventListener('input', debounce(() => {
            intentBtn.disabled = !intentInput.value.trim();
          }, 300));
          intentBtn.addEventListener('click', () => this.overrideIntent());
        }
        this.elements.agentDetailContainer.querySelectorAll('.memory-item').forEach(item => {
          item.addEventListener('click', () => {
            const idx = item.getAttribute('data-idx');
            const memory = (agent.recent_memories || agent.memories || agent.memory_log || [])[idx];
            if (memory) {
              this.showMemoryModal(renderKeyValues(memory));
            }
          });
        });
      },

      renderLogs(logs, append = false) {
        if (!Array.isArray(logs)) return;
        const html = logs.map(l => {
          const ts = l.timestamp || l.time || '';
          const lvl = l.level || l.severity || 'INFO';
          const msg = l.message || l.msg || (typeof l === 'string' ? l : JSON.stringify(l));
          return `<div class="flex space-x-2"><span class="text-gray-500">${ts}</span><span class="text-gray-400">[${lvl}]</span><span class="text-gray-200 flex-1">${msg}</span></div>`;
        }).join('');
        if (append) {
          this.elements.liveLogContainer.innerHTML += html;
        } else {
          this.elements.liveLogContainer.innerHTML = html;
        }
        this.elements.liveLogContainer.scrollTop = this.elements.liveLogContainer.scrollHeight;
      },

      renderInterventions(interventions) {
        this.elements.interventionContainer.innerHTML = interventions.length ? interventions.map(i => `
          <div class="bg-gray-900/50 border border-gray-700 rounded p-3 mb-2">
            <div class="text-sm text-gray-200">${i.request_id || 'Request'}</div>
            <div class="text-xs text-gray-400">${i.description || i.message || 'Pending human response'}</div>
            <button data-id="${i.request_id}" class="mt-2 px-3 py-1 bg-indigo-600 hover:bg-indigo-500 text-white rounded text-xs respond-btn" aria-label="Respond to intervention ${i.request_id}">Respond</button>
          </div>
        `).join('') : '<div class="text-xs text-gray-400">No pending interventions.</div>';
        this.elements.interventionContainer.querySelectorAll('.respond-btn').forEach(btn => {
          btn.addEventListener('click', () => {
            const id = btn.getAttribute('data-id');
            this.showResponseModal(id);
          });
        });
      },

      showResponseModal(requestId) {
        this.elements.responseModalBody.innerHTML = `
          <div class="text-gray-200 text-sm mb-4">Enter response for ${requestId}</div>
          <textarea id="response-input" class="w-full bg-gray-900 border border-gray-700 rounded p-2 text-gray-200" rows="4" placeholder="Enter your response..." aria-label="Intervention response"></textarea>
          <button id="submit-response-btn" class="mt-3 px-4 py-2 bg-indigo-600 hover:bg-indigo-500 text-white rounded font-semibold" aria-label="Submit response">Submit</button>
        `;
        this.elements.responseModal.style.display = 'flex';
        const responseInput = document.getElementById('response-input');
        const submitBtn = document.getElementById('submit-response-btn');
        if (responseInput && submitBtn) {
          submitBtn.disabled = !responseInput.value.trim();
          responseInput.addEventListener('input', debounce(() => {
            submitBtn.disabled = !responseInput.value.trim();
          }, 300));
          submitBtn.addEventListener('click', () => {
            const response = responseInput.value;
            if (response.trim()) {
              this.submitInterventionResponse(requestId, response);
            }
          });
        }
      },

      hideResponseModal() { this.elements.responseModal.style.display = 'none'; },
      showMemoryModal(html) { this.elements.memoryModalBody.innerHTML = html || ''; this.elements.memoryModal.style.display = 'flex'; },
      hideMemoryModal() { this.elements.memoryModal.style.display = 'none'; },
    };

    document.addEventListener('DOMContentLoaded', () => DashboardApp.init());
  </script>
</body>
</html>
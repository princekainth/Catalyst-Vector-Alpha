<!DOCTYPE html>
<html lang="en" class="dark">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Catalyst Supervisor Dashboard</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.3/dist/chart.umd.min.js"></script>
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Fira+Code:wght@400;500&display=swap" rel="stylesheet" />
  <style>
    body { font-family: 'Inter', sans-serif; background: linear-gradient(135deg,#0f172a 0%,#1e3a8a 100%); color:#e5e7eb; }
    .font-mono{ font-family:'Fira Code', monospace; }
    #activity-list::-webkit-scrollbar, #plan-list::-webkit-scrollbar{ width:6px; }
    #activity-list::-webkit-scrollbar-thumb, #plan-list::-webkit-scrollbar-thumb{ background:#60a5fa; border-radius:3px; }
    .user-bubble{ background:#3b82f6; color:#fff; align-self:flex-end; margin-left:auto; }
    .ai-bubble{ background:#1f2937; color:#d1d5db; align-self:flex-start; }
    .alert-bubble{ background:#ef4444; color:#fff; align-self:flex-start; }
    .bubble{ box-shadow:0 4px 12px rgba(0,0,0,.2); }
    .panel{ transition:opacity .2s ease; }
    .hidden{ display:none; }
    .spinner{ border:2px solid #3b82f6; border-top-color:transparent; border-radius:50%; width:1.25rem; height:1.25rem; animation:spin 1s linear infinite; }
    @keyframes spin{ to{transform:rotate(360deg)} }
    #toast-container{ position:fixed; bottom:1rem; right:1rem; z-index:50; display:flex; flex-direction:column; gap:.5rem; }
    .toast{ background:#10b981; color:#fff; padding:.5rem .9rem; border-radius:.5rem; box-shadow:0 4px 12px rgba(0,0,0,.3); }
    .connection-status { display:inline-block; width:8px; height:8px; border-radius:50%; margin-right:8px; }
    .connected { background-color:#10b981; }
    .disconnected { background-color:#ef4444; }
    .simulation-mode { background-color:#f59e0b; }
    .plan-step{ border-left:3px solid #60a5fa; padding-left:8px; margin:4px 0; }
    .btn{ display:inline-block; padding:.5rem .75rem; border-radius:.5rem; background:#2563eb; color:#fff; }
    .btn:hover{ background:#1d4ed8; }
    code.small { background:#0b1220; padding:2px 6px; border-radius:6px; }
  </style>
</head>
<body class="flex flex-col h-screen">
  <div id="toast-container"></div>

  <header class="bg-gray-900/90 backdrop-blur-sm text-center p-4 border-b border-gray-800 shadow-lg flex-shrink-0">
    <h1 class="text-2xl font-bold text-white flex items-center justify-center">
      <span id="connection-indicator" class="connection-status simulation-mode"></span>
      Catalyst Vector Alpha Dashboard
    </h1>
    <div class="flex justify-center space-x-4 mt-2">
      <button id="toggle-activity-panel" class="text-sm text-blue-400 hover:text-white transition-colors">Live Activity</button>
      <button id="toggle-plans-panel" class="text-sm text-gray-400 hover:text-white transition-colors">Active Plans</button>
      <button id="toggle-health-panel" class="text-sm text-gray-400 hover:text-white transition-colors">System Health</button>
      <button id="toggle-insight-panel" class="text-sm text-gray-400 hover:text-white transition-colors">Latest Insight</button>
    </div>
  </header>

  <div id="panel-container" class="relative">
    <!-- Live Activity Panel -->
    <div id="activity-panel" class="panel bg-gray-800/90 p-4 border-b border-gray-700 w-full">
      <h2 class="text-lg font-semibold text-white">Live Activity Stream</h2>
      <ul id="activity-list" class="space-y-2 mt-2 font-mono text-xs overflow-y-auto h-48 bg-gray-900/50 p-2 rounded-md">
        <li class="flex justify-center items-center h-full text-gray-500">Awaiting system events...</li>
      </ul>
    </div>

    <!-- Active Plans Panel -->
    <div id="plans-panel" class="panel bg-gray-800/90 p-4 border-b border-gray-700 hidden w-full">
      <h2 class="text-lg font-semibold text-white">Active Plans & Pending Mission</h2>

      <!-- Pending Mission card (pulls /api/pending; approves via /api/approve) -->
      <div id="pending-card" class="bg-gray-900/50 p-3 rounded-md mb-3">
        <div id="pending-body" class="text-sm text-gray-300">
          <span class="text-gray-400">Checking for pending mission…</span>
        </div>
      </div>

      <div id="plans-container" class="mt-3">
        <ul id="plan-list" class="space-y-2 overflow-y-auto h-48 bg-gray-900/50 p-2 rounded-md">
          <li class="text-gray-500 text-center">No active plans</li>
        </ul>
      </div>
    </div>

    <!-- System Health Panel -->
    <div id="health-panel" class="panel bg-gray-800/90 p-4 border-b border-gray-700 hidden w-full">
      <div id="health-loader" class="flex justify-center items-center h-24">
        <div class="spinner"></div>
      </div>
      <div id="health-content" class="hidden">
        <canvas id="system-health-chart" class="w-full h-32"></canvas>
        <div class="mt-4 grid grid-cols-2 gap-4 text-sm">
          <div class="bg-gray-900/50 p-3 rounded">
            <div class="text-gray-400">Current CPU</div>
            <div id="current-cpu" class="text-xl font-bold text-blue-400">--</div>
          </div>
          <div class="bg-gray-900/50 p-3 rounded">
            <div class="text-gray-400">Current Memory</div>
            <div id="current-memory" class="text-xl font-bold text-green-400">--</div>
          </div>
        </div>
      </div>
    </div>

    <!-- Insight Panel -->
    <div id="insight-panel" class="panel bg-gray-800/90 p-4 border-b border-gray-700 hidden w-full">
      <h2 class="text-lg font-semibold text-white">Latest Agent Insight</h2>
      <div id="insight-box" class="bg-gray-900/50 p-3 rounded text-sm text-gray-300 mt-2">
        <span class="text-gray-500">Loading latest insight…</span>
      </div>
    </div>
  </div>

  <main id="chat-container" class="flex-1 overflow-y-auto p-6 flex flex-col space-y-4">
    <div class="ai-bubble bubble w-fit max-w-lg rounded-xl p-3">
      <p>Catalyst Vector Alpha system online. Multi-agent coordination active and ready for directives.</p>
    </div>
  </main>

  <footer class="bg-gray-900/90 p-4 border-t border-gray-800 flex-shrink-0">
    <div class="max-w-3xl mx-auto flex items-end bg-gray-800 rounded-xl p-2 shadow-inner">
      <textarea id="user-input" class="flex-1 bg-transparent text-gray-200 focus:outline-none resize-none px-3 sm:text-lg" placeholder="Issue a directive to the swarm..." rows="1"></textarea>
      <button id="send-btn" class="bg-blue-600 text-white rounded-lg w-12 h-12 flex items-center justify-center ml-2 hover:bg-blue-500 transition-colors disabled:bg-gray-600 flex-shrink-0" aria-label="Send Message">
        <svg id="send-icon" xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 12h14M12 5l7 7-7 7"/></svg>
        <div id="send-spinner" class="spinner hidden"></div>
      </button>
    </div>
  </footer>

  <script>
  const UI = {
    el: {},
    chart: null,
    connectionStatus: 'simulation', // 'connected' | 'disconnected' | 'simulation'

    init() {
      this.cache();
      this.bind();
      this.initChart();
      this.detectConnection();
      this.togglePanel('activity'); // default
      this.pollers();
    },

    cache() {
      this.el = {
        connectionIndicator: document.getElementById('connection-indicator'),
        activityPanel: document.getElementById('activity-panel'),
        plansPanel: document.getElementById('plans-panel'),
        healthPanel: document.getElementById('health-panel'),
        insightPanel: document.getElementById('insight-panel'),
        toggleActivityBtn: document.getElementById('toggle-activity-panel'),
        togglePlansBtn: document.getElementById('toggle-plans-panel'),
        toggleHealthBtn: document.getElementById('toggle-health-panel'),
        toggleInsightBtn: document.getElementById('toggle-insight-panel'),
        activityList: document.getElementById('activity-list'),
        planList: document.getElementById('plan-list'),
        pendingBody: document.getElementById('pending-body'),
        healthLoader: document.getElementById('health-loader'),
        healthContent: document.getElementById('health-content'),
        chartCanvas: document.getElementById('system-health-chart'),
        currentCpu: document.getElementById('current-cpu'),
        currentMemory: document.getElementById('current-memory'),
        insightBox: document.getElementById('insight-box'),
        userInput: document.getElementById('user-input'),
        sendBtn: document.getElementById('send-btn'),
        sendIcon: document.getElementById('send-icon'),
        sendSpinner: document.getElementById('send-spinner'),
        chatContainer: document.getElementById('chat-container'),
        toastContainer: document.getElementById('toast-container'),
      };
    },

    bind() {
      this.el.toggleActivityBtn.onclick = () => this.togglePanel('activity');
      this.el.togglePlansBtn.onclick = () => this.togglePanel('plans');
      this.el.toggleHealthBtn.onclick = () => this.togglePanel('health');
      this.el.toggleInsightBtn.onclick = () => this.togglePanel('insight');

      this.el.sendBtn.addEventListener('click', () => this.sendMessage());
      this.el.userInput.addEventListener('keydown', e => {
        if (e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); this.sendMessage(); }
      });
      this.el.userInput.addEventListener('input', () => this.autoResizeTextarea());
    },

    detectConnection: async function() {
      try {
        const r = await fetch('/api/health');
        if (!r.ok) throw new Error();
        const j = await r.json();
        if (j?.data?.loop_alive) {
          this.connectionStatus = 'connected';
          this.toast('Connected to CVA');
        } else {
          this.connectionStatus = 'simulation';
          this.toast('Simulation mode (loop not alive)');
        }
      } catch {
        this.connectionStatus = 'simulation';
        this.toast('Simulation mode (no backend)');
      }
      this.updateConnectionIndicator();
    },

    updateConnectionIndicator() {
      const s = this.connectionStatus === 'connected' ? 'connected' :
                this.connectionStatus === 'disconnected' ? 'disconnected' : 'simulation-mode';
      this.el.connectionIndicator.className = `connection-status ${s}`;
    },

    togglePanel(name) {
      const map = { activity: 'activityPanel', plans: 'plansPanel', health: 'healthPanel', insight: 'insightPanel' };
      Object.values(map).forEach(k => this.el[k].classList.add('hidden'));
      this.el[map[name]].classList.remove('hidden');
      if (name === 'health') this.updateSystemHealth(true);
      if (name === 'plans') { this.fetchPending(); this.fetchPlans(); }
      if (name === 'insight') this.fetchInsight();
    },

    pollers() {
      setInterval(() => this.updateEvents(), 2000);
      setInterval(() => this.updateSystemHealth(), 5000);
      setInterval(() => this.fetchPlans(), 5000);
      setInterval(() => this.fetchPending(), 5000);
    },

    // -------- Activity/events ----------
    async updateEvents() {
      try {
        const r = await fetch('/api/event_stream');
        if (!r.ok) throw new Error();
        const events = await r.json();
        this.renderEvents(Array.isArray(events) ? events.slice(-20) : []);
      } catch {
        this.connectionStatus = 'disconnected';
        this.updateConnectionIndicator();
      }
    },

    renderEvents(events) {
      if (!events.length) {
        this.el.activityList.innerHTML = '<li class="text-gray-500 text-center">No events yet</li>';
        return;
      }
      this.el.activityList.innerHTML = '';
      events.forEach(ev => {
        const li = document.createElement('li');
        li.innerHTML =
          `<span class="font-mono text-xs text-gray-400">[${new Date(ev.timestamp).toLocaleTimeString()}]</span>
           <span class="text-blue-300 ml-2">${ev.type || 'log'}</span>:
           <span class="text-gray-300">${ev.description || ''}</span>`;
        this.el.activityList.appendChild(li);
      });
      this.el.activityList.scrollTop = this.el.activityList.scrollHeight;
    },

    // -------- Plans + Approvals ----------
    async fetchPlans() {
      try {
        const r = await fetch('/api/catalyst/plans');
        if (!r.ok) throw new Error();
        const j = await r.json();
        const plans = Array.isArray(j?.data) ? j.data : [];
        this.renderPlans(plans);
      } catch {
        this.el.planList.innerHTML = '<li class="text-gray-500 text-center">Unable to load plans</li>';
      }
    },

    renderPlans(plans) {
      const list = this.el.planList;
      if (!plans.length) {
        list.innerHTML = '<li class="text-gray-500 text-center">No active plans</li>';
        return;
      }
      list.innerHTML = '';
      plans.forEach(p => {
        const li = document.createElement('li');
        li.className = 'plan-step bg-gray-900/30 p-2 rounded text-sm';
        li.innerHTML = `
          <div class="flex justify-between items-center">
            <span class="font-mono text-blue-300">${p.task_id || 'unknown-id'}</span>
            <span class="text-xs text-gray-400">${p.status}</span>
          </div>
          <div class="text-sm text-gray-300 mt-1">
            Action: <code class="small">${p.action}</code> — 
            <code class="small">${p.namespace || 'default'}/${p.deployment}</code> → 
            <code class="small">${p.replicas}</code>
          </div>`;
        list.appendChild(li);
      });
    },

    async fetchPending() {
      try {
        const r = await fetch('/api/pending');
        if (!r.ok) throw new Error();
        const j = await r.json();
        const p = j?.pending;
        if (!p) {
          this.el.pendingBody.innerHTML = '<span class="text-gray-500">No pending mission.</span>';
          return;
        }
        const created = p.created_at ? new Date(p.created_at * 1000).toLocaleString() : (p.ts ? new Date(p.ts * 1000).toLocaleString() : '-');
        this.el.pendingBody.innerHTML = `
          <div class="text-sm space-y-1">
            <div><strong>Action:</strong> <code class="small">${p.action}</code></div>
            <div><strong>Params:</strong> <code class="small">${(p.namespace||'default')}/${p.deployment}</code> → <code class="small">${p.replicas}</code></div>
            <div><strong>Approval Token:</strong> <code class="small">${p.approval_token || '—'}</code></div>
            <div><strong>Status:</strong> ${p.status || 'awaiting_approval'}</div>
            <div><strong>Created:</strong> ${created}</div>
            <div class="pt-2">
              <button id="approve-btn" class="btn">Approve & Execute</button>
              <span id="approve-status" class="text-gray-400 ml-2"></span>
            </div>
          </div>`;
        document.getElementById('approve-btn').onclick = () => this.approvePending(p);
      } catch {
        this.el.pendingBody.innerHTML = '<span class="text-red-400">Failed to load pending mission.</span>';
      }
    },

    async approvePending(p) {
      const status = document.getElementById('approve-status');
      status.textContent = 'Approving…';
      try {
        const body = { approval_token: p.approval_token, task_id: p.task_id };
        const r = await fetch('/api/approve', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(body)
        });
        const j = await r.json();
        if (!r.ok || !j.ok) throw new Error(j?.error || j?.detail?.error || 'Approval failed');
        status.textContent = 'Approved ✅';
        this.toast(`Scaled ${p.deployment} to ${p.replicas}`);
        setTimeout(() => { this.fetchPending(); this.fetchPlans(); }, 800);
      } catch (e) {
        status.textContent = 'Failed';
        this.toast(e.message || 'Approval failed', true);
      }
    },

    // -------- System health ----------
    initChart() {
      const ctx = document.getElementById('system-health-chart').getContext('2d');
      this.chart = new Chart(ctx, {
        type: 'line',
        data: { labels: [], datasets: [
          { label: 'CPU %', data: [], borderColor: '#60a5fa', backgroundColor: 'rgba(96,165,250,0.1)', tension: 0.3 },
          { label: 'Memory %', data: [], borderColor: '#10b981', backgroundColor: 'rgba(16,185,129,0.1)', tension: 0.3 }
        ]},
        options: {
          responsive: true, animation: false, interaction: { intersect: false, mode: 'index' },
          scales: {
            y: { min: 0, max: 100, ticks: { color: '#9ca3af' }, grid: { color: 'rgba(156,163,175,0.1)' } },
            x: { ticks: { color: '#9ca3af' }, grid: { color: 'rgba(156,163,175,0.1)' } }
          },
          plugins: { legend: { labels: { color: '#e5e7eb' } } }
        }
      });
    },

    async updateSystemHealth(initial=false) {
      try {
        const r = await fetch('/api/system_metrics');
        if (!r.ok) throw new Error();
        const j = await r.json();
        const d = j?.data || {};
        const cpu = +d.cpu || 0, memory = +d.memory || 0, ts = Date.now();
        this.el.healthLoader.classList.add('hidden');
        this.el.healthContent.classList.remove('hidden');
        this.el.currentCpu.textContent = `${cpu.toFixed(1)}%`;
        this.el.currentMemory.textContent = `${memory.toFixed(1)}%`;

        const L = this.chart.data.labels, cpuD = this.chart.data.datasets[0].data, memD = this.chart.data.datasets[1].data;
        L.push(new Date(ts).toLocaleTimeString()); cpuD.push(cpu); memD.push(memory);
        if (L.length > 30) { L.shift(); cpuD.shift(); memD.shift(); }
        this.chart.update('none');
      } catch {
        if (!initial) this.toast('System metrics unavailable', true);
      }
    },

    // -------- Insight ----------
    async fetchInsight() {
      try {
        const r = await fetch('/api/latest_insight');
        if (!r.ok) throw new Error();
        const j = await r.json();
        const text = j?.data?.insight || 'No recent insights available.';
        this.el.insightBox.textContent = text;
      } catch {
        this.el.insightBox.textContent = 'Unable to fetch latest insight.';
      }
    },

    // -------- Command handling ----------
    async sendMessage() {
      const msg = this.el.userInput.value.trim();
      if (!msg) return;
      this.addMessage(msg, 'user');
      this.el.userInput.value = ''; this.autoResizeTextarea();

      if (this.connectionStatus !== 'connected') {
        this.addMessage('Simulation: command accepted.', 'ai');
        return;
      }

      try {
        this.setSending(true);
        const r = await fetch('/api/command', {
          method: 'POST',
          headers: {'Content-Type':'application/json'},
          body: JSON.stringify({ command: msg })
        });
        const j = await r.json();
        if (!r.ok) throw new Error(j?.error || 'Dispatch failed');
        const taskId = j.task_id;
        this.addMessage('Command dispatched to swarm. Monitoring execution…', 'ai');
        if (taskId) this.pollTask(taskId);
      } catch (e) {
        this.addMessage(`Command error: ${e.message}`, 'alert');
      } finally {
        this.setSending(false);
      }
    },

    async pollTask(taskId, retries=30) {
      const delay = ms => new Promise(r => setTimeout(r, ms));
      for (let i=0;i<retries;i++) {
        try {
          const r = await fetch(`/api/catalyst/task_status/${taskId}`);
          if (!r.ok) throw new Error();
          const j = await r.json();
          if (j.status === 'completed' || j.status === 'failed') {
            const m = j.result?.summary || `Task ${j.status}.`;
            this.addMessage(m, j.status === 'failed' ? 'alert' : 'ai');
            return;
          }
        } catch {}
        await delay(2000);
      }
      this.addMessage('Task monitoring timeout. Check logs.', 'alert');
    },

    // -------- Small utils ----------
    autoResizeTextarea() {
      const el = this.el.userInput;
      el.style.height = 'auto';
      el.style.height = Math.min(el.scrollHeight, 200) + 'px';
    },
    addMessage(text, kind='ai') {
      const div = document.createElement('div');
      div.className = `${kind==='user'?'user-bubble':kind==='alert'?'alert-bubble':'ai-bubble'} bubble w-fit max-w-lg rounded-xl p-3`;
      div.innerText = text;
      this.el.chatContainer.appendChild(div);
      this.el.chatContainer.scrollTop = this.el.chatContainer.scrollHeight;
    },
    setSending(on) {
      this.el.sendBtn.disabled = on;
      this.el.sendIcon.classList.toggle('hidden', on);
      this.el.sendSpinner.classList.toggle('hidden', !on);
    },
    toast(msg, isError=false) {
      const d = document.createElement('div');
      d.className = 'toast';
      d.style.background = isError ? '#ef4444' : '#10b981';
      d.textContent = msg;
      this.el.toastContainer.appendChild(d);
      setTimeout(()=>d.remove(), 3000);
    }
  };

  document.addEventListener('DOMContentLoaded', () => UI.init());
  </script>
</body>
</html>
